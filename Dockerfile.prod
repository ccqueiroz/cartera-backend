FROM node:18-alpine as builder

LABEL mainteiner 'Caio Queiroz - App Cartera'

WORKDIR /usr/src/app

ARG FIREBASE_TOKEN
ENV FIREBASE_TOKEN=$FIREBASE_TOKEN
ARG FIREBASE_SERVICE_ACCOUNT_TYPE
ENV FIREBASE_SERVICE_ACCOUNT_TYPE=$FIREBASE_SERVICE_ACCOUNT_TYPE
ARG FIREBASE_SERVICE_ACCOUNT_PROJECT_ID
ENV FIREBASE_SERVICE_ACCOUNT_PROJECT_ID=$FIREBASE_SERVICE_ACCOUNT_PROJECT_ID
ARG FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY_ID
ENV FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY_ID=$FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY_ID
ARG FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY
ENV FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY=$FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY
ARG FIREBASE_SERVICE_ACCOUNT_CLIENT_EMAIL
ENV FIREBASE_SERVICE_ACCOUNT_CLIENT_EMAIL=$FIREBASE_SERVICE_ACCOUNT_CLIENT_EMAIL
ARG FIREBASE_SERVICE_ACCOUNT_CLIENT_ID
ENV FIREBASE_SERVICE_ACCOUNT_CLIENT_ID=$FIREBASE_SERVICE_ACCOUNT_CLIENT_ID
ARG FIREBASE_SERVICE_ACCOUNT_AUTH_URI
ENV FIREBASE_SERVICE_ACCOUNT_AUTH_URI=$FIREBASE_SERVICE_ACCOUNT_AUTH_URI
ARG FIREBASE_SERVICE_ACCOUNT_TOKEN_URI
ENV FIREBASE_SERVICE_ACCOUNT_TOKEN_URI=$FIREBASE_SERVICE_ACCOUNT_TOKEN_URI
ARG FIREBASE_SERVICE_ACCOUNT_AUTH_PROVIDER_URL
ENV FIREBASE_SERVICE_ACCOUNT_AUTH_PROVIDER_URL=$FIREBASE_SERVICE_ACCOUNT_AUTH_PROVIDER_URL
ARG FIREBASE_SERVICE_ACCOUNT_CLIENT_URL
ENV FIREBASE_SERVICE_ACCOUNT_CLIENT_URL=$FIREBASE_SERVICE_ACCOUNT_CLIENT_URL
ARG FIREBASE_SERVICE_ACCOUNT_UNIVERSE_DOMAIN
ENV FIREBASE_SERVICE_ACCOUNT_UNIVERSE_DOMAIN=$FIREBASE_SERVICE_ACCOUNT_UNIVERSE_DOMAIN

ENV DOCKERIZE_VERSION v0.7.0

RUN apk add --no-cache wget curl bash tar \
    && wget -O - https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz \
    | tar xzf - -C /usr/local/bin \
    && rm -rf /var/cache/apk/*

COPY ./package.json ./yarn.lock .

RUN yarn install --production --frozen-lockfile

COPY . .

RUN npm install -g firebase-tools

RUN chmod +x entrypoint.sh

RUN yarn add ts-node dotenv-cli -D

RUN yarn migrate

RUN ./entrypoint.sh

RUN yarn remove ts-node dotenv-cli

RUN yarn build

# ====================================================================================================================== #
FROM node:18-alpine as main

WORKDIR /usr/src/app

RUN apk add --no-cache curl

COPY --from=builder /usr/src/app/dist ./dist

COPY --from=builder /usr/src/app/node_modules ./node_modules

COPY --from=builder /usr/src/app/package.json ./package.json

COPY --from=builder /usr/local/bin/dockerize /usr/local/bin/dockerize

CMD ["yarn", "start:prod"]
